<?php
	((NbPoiReactive * 1 + NbPoiNonReactive * 0.1) * CoefCaff) + (%Retard * NbPoiReactive * 1) - (NbPoiRayon(20km) * 0.5)->MAX(20) + (NbPoiReactiveSimu * 1 + NbPoiNonReactiveSimu * 0.1);
	
	"SELECT id, name_related, mobile_phone, work_email, site, site_id, agence, reactive, non_reactive, (((reactive * 1) + (non_reactive * 0.1)) * (1 / caff.ag_coeff_traitement)) charge_initiale, ((((reactive * 1) + (non_reactive * 0.1)) * (1 / caff.ag_coeff_traitement))
		+ ((SELECT (dre_ko / (dre_ko + dre_ok)) retard FROM (select atr_caff_traitant_id,count(dre_ko) as dre_ko,count(dre_ok) as dre_ok from(select atr_caff_traitant_id,ft_oeie_dre,case when (ft_oeie_dre IS NULL OR ft_oeie_dre <= NOW()) and id not in (122386, 60071, 93786, 93411, 71037, 88174, 140385, 141328, 142156, 97011, 60568, 110865, 93979, 100858, 98158, 100235, 100692, 98583, 96646, 97018, 110984, 121481, 116341, 60370, 137238, 137245, 75634, 122419, 141338, 137640, 137617, 140233, 141006, 137885, 116164, 137475, 136051, 137688, 142158, 140744, 141252, 140840, 87356, 147467, 147136, 112759, 136088, 100716, 93401, 100503, 110092, 110028, 137275, 110903, 112494, 110078, 112854, 112497, 116100, 141357, 122351, 116163, 139991, 142113, 136086, 112492, 114627, 122413, 122397, 97823, 122444, 141758, 72387, 142135, 137690, 122261, 98320, 100869, 98879, 100274, 111553, 112500, 137256, 58839, 97941, 114352, 118270, 137259, 137236, 137686, 101992, 86926, 141346, 23941, 114609, 137875, 98867, 141767, 110046, 114004, 76031, 73204, 141768, 55821, 97000, 141010, 122269, 73199, 89041, 96645, 87550, 116169, 141760, 122348, 140762, 113100, 110094, 122331, 147137, 98869, 101410, 88787, 75323, 98588, 136053, 101406, 114011, 59963, 94371, 137647, 112605, 101772, 112469, 114019, 147476, 137918, 140411, 90175, 150084, 94368, 140406, 116162, 68573, 25218, 54864, 141011, 150089, 147138, 140415, 71377, 58805, 142131, 63188, 151366, 110095, 122274, 150086, 108427, 142153, 84406, 141322, 114341, 136047, 142132, 140255, 139997, 141316, 108364, 65916, 97131, 116151, 91011, 89349, 140417, 98136, 82283, 78467, 137749, 85435, 78465, 82282, 120719, 112721, 137855, 94412, 70902, 141385, 97044, 135917, 110967, 140328, 131550, 86806, 73363, 121996, 134835, 99343, 135951, 137573, 100923, 78473, 78466, 100922, 68163, 137554, 137568, 139966, 136017, 135920, 131551, 113329, 137563, 102532, 68150, 78468, 94400, 78429, 78432, 78437, 78440, 78430, 78436, 78431, 78439, 82285, 78434, 78442, 78438, 78441, 78435, 78433, 82286, 135968, 90107, 86830, 82284, 79353, 131552, 131540, 131541, 131544, 131546, 86828, 131547, 86843, 86832, 86841, 86836, 94407, 90110, 131539, 98929, 86831, 86838, 131548, 86839, 131543, 86835, 94416, 86840, 131542, 114216, 99332, 131549, 110109, 97065, 98849, 98847, 110107, 98569, 109625, 98568, 98567, 110108, 94411, 113326, 82291, 86829, 150161, 146971, 150162, 150160, 146970, 146972, 86834, 141363, 70900, 141194, 141162, 141193, 111943, 141405, 101852, 141364, 140973, 141163, 141406, 135949, 137854, 78444, 136167, 137548, 137657, 98848, 137549, 136030, 137553, 136029, 120063, 139965, 137550, 86842, 135944, 114219, 120087, 114215, 137658, 114218, 135936, 117142, 99331, 87623, 135967, 94399, 131545, 112720, 140322, 135945, 114638, 86833, 120088, 102417, 137848, 135942, 135919, 135918, 140974, 135943, 101851, 117141, 87624, 141369, 141410, 150727, 112538, 112555, 137753, 83698, 120077, 142137, 151390, 150856, 87541, 78457, 56247, 112719, 117151, 102426, 78456, 110961, 151433, 109626, 111626, 137656, 141370, 140207, 78694, 102535, 137849, 85433, 141400, 120092, 110908, 141368, 85434, 140958, 150254, 151908, 112493, 150132, 101727, 147570, 87161, 151543, 150159, 114404, 151542, 151541, 139963, 150287, 6003, 139962, 136039, 6004, 152483, 141105, 120314, 137850, 141754, 147089, 120384, 97662, 96987, 114981, 83158, 152420, 150243, 67658, 152286, 151903, 152288, 150094, 137682, 140217, 93965, 100649, 122770, 139938, 85469, 96744, 142445, 73787, 151915, 90666, 74496, 110330, 142103, 110328, 152399, 152965, 140213, 116384, 151901, 5303, 116358, 152846, 100077, 5766, 153518, 150170, 120256, 112164, 110930, 152097, 151341, 152823, 150182, 152474, 137520, 112126, 153611, 111146, 135667, 140347, 150167, 150878, 70259, 150166, 150858, 136173, 151752, 114416, 141409, 150875, 151726, 113774, 137519, 112073, 97659, 139964, 147438, 142161, 136166, 116490, 137584, 142500, 137659, 142074, 114413, 6098, 89637, 151343, 141107, 151503, 137841, 84447, 141104, 97069, 151921, 99918, 139181, 68149, 150050, 151961, 49546, 152896, 122659, 151897, 141480, 154679, 147073, 76964, 88538, 90282, 111680, 113919, 98736, 137368, 137366, 152736, 153316, 153760, 147617, 112072, 98687, 151221, 147440, 150781, 152920, 136080, 150710, 102181, 151605, 136043, 151064, 100950, 141885, 114403, 151725, 151436, 151719, 152910, 108402, 152412, 68168, 154604, 152919, 116142, 75871, 116364, 151437, 152234, 152402, 98921, 137725, 148011, 142485, 85443, 152782, 65308, 65307, 151932, 83249, 152237, 67280, 111259, 27338, 101489, 72410, 67169, 102253, 102252, 154305, 57370, 52817, 47909, 68276, 75413, 110723, 90576, 52804, 60985, 98347, 60986, 98823, 5483, 83490, 93632, 94252, 5875, 6049, 152497, 93565, 94251, 90888, 152966, 110925, 140916, 155571, 94572, 88433, 147475, 153154, 113337, 152748, 99047, 147474, 70898, 121587, 113336, 97878, 110103, 135131, 121589, 151530, 135986, 140348, 108827, 97057, 101538, 122051, 110954, 114414, 136023, 136024, 110957, 150872, 114407, 153689, 141118, 152876, 115371, 86837, 122703, 153331, 147441, 27655, 97694, 98999, 97983, 89908, 90876, 141645, 154761, 75630, 97116, 112541, 155706, 155276, 153739, 151546, 152413, 151545, 155869, 151544, 154606, 155870, 154605, 150874, 84656, 83542, 137886, 154922, 156055, 111571, 152935, 114412, 56050, 61049, 65309, 98636, 155997, 155269, 156183, 155285, 6007, 156001, 155843, 6179, 153507, 142504, 151342, 70029, 155846, 140821, 152466, 147169, 156453, 74312, 152824, 156755, 155998, 156749, 84753, 66581, 89410, 98207, 101537, 154764, 88411, 147167, 88461, 152416, 140761, 153600, 122548, 151263, 151264, 151271, 155624, 155625, 156492, 152417, 156490, 156491, 156206, 152676, 150463, 52964, 156631, 57016, 69071, 83693, 151258, 150290, 56692, 72345, 90866, 108381, 154887, 139820, 114368, 154766, 151425, 155544, 155055, 57416, 152209, 154457, 154805, 140727, 96600, 153224, 155550, 156409, 156354, 156410, 156408, 140746, 152485, 112632, 154455, 155572, 150997, 150077, 154914, 156477, 89090, 122455, 137237, 151424, 90603, 141333, 152947, 141304, 89517, 152841, 156476, 153725, 94854, 71926, 152953, 70965, 94647, 86783, 154997, 63184, 142344, 78340, 157035, 76944, 120337, 156350, 156721, 156718, 156809, 156368, 157423, 89854, 156567, 156858, 155637, 157439, 157429, 157430, 157425, 156970, 120070, 116311, 113560, 150238, 156737, 150725, 84895, 108403, 101753, 76950, 57432, 83406, 56202, 154203, 156018, 156632, 156675, 151635, 155636, 155631, 157174, 121932, 155027, 156198, 155911, 154705, 157198, 155811, 155810, 156389, 157005, 157006, 157032, 156397, 157382, 157628, 154750, 156267, 152020, 152901, 154280, 155452, 156277, 152021, 156278, 154985, 157499, 101139, 87641, 78885, 152262, 152453, 72305, 153515, 98147, 110025, 152579, 156079, 153606, 154990, 154806, 156344, 137670, 150415, 5596, 6169, 109852, 153508, 140668, 94920, 122053, 154504, 157667, 137825, 100976, 157678, 78165, 98816, 101091, 5112, 89416, 155833, 121891, 156454, 153511, 153662, 5075, 116497, 156763, 156441, 156750, 157496, 84755, 110692, 149981, 157511, 102286, 157138, 157508, 156884, 156873, 6135, 157495, 157153, 94450, 156178, 155731, 5292, 26947, 157134, 110338, 110337, 77500, 88416, 74569, 87501, 98188, 71193, 71194, 116456, 76748, 5459, 76707, 76706, 139978, 59495, 147164, 151497, 153663, 156753, 157154, 140182, 74783, 101738, 101739, 101740, 141325, 85598, 101405, 153728, 75310, 156197, 157558, 158104, 157102, 94344, 116144, 158258, 158259, 156657, 156658, 155857, 157783, 157782, 156232, 156648, 156894) then 1 end as dre_ko,case when ft_oeie_dre > NOW() or id in (122386, 60071, 93786, 93411, 71037, 88174, 140385, 141328, 142156, 97011, 60568, 110865, 93979, 100858, 98158, 100235, 100692, 98583, 96646, 97018, 110984, 121481, 116341, 60370, 137238, 137245, 75634, 122419, 141338, 137640, 137617, 140233, 141006, 137885, 116164, 137475, 136051, 137688, 142158, 140744, 141252, 140840, 87356, 147467, 147136, 112759, 136088, 100716, 93401, 100503, 110092, 110028, 137275, 110903, 112494, 110078, 112854, 112497, 116100, 141357, 122351, 116163, 139991, 142113, 136086, 112492, 114627, 122413, 122397, 97823, 122444, 141758, 72387, 142135, 137690, 122261, 98320, 100869, 98879, 100274, 111553, 112500, 137256, 58839, 97941, 114352, 118270, 137259, 137236, 137686, 101992, 86926, 141346, 23941, 114609, 137875, 98867, 141767, 110046, 114004, 76031, 73204, 141768, 55821, 97000, 141010, 122269, 73199, 89041, 96645, 87550, 116169, 141760, 122348, 140762, 113100, 110094, 122331, 147137, 98869, 101410, 88787, 75323, 98588, 136053, 101406, 114011, 59963, 94371, 137647, 112605, 101772, 112469, 114019, 147476, 137918, 140411, 90175, 150084, 94368, 140406, 116162, 68573, 25218, 54864, 141011, 150089, 147138, 140415, 71377, 58805, 142131, 63188, 151366, 110095, 122274, 150086, 108427, 142153, 84406, 141322, 114341, 136047, 142132, 140255, 139997, 141316, 108364, 65916, 97131, 116151, 91011, 89349, 140417, 98136, 82283, 78467, 137749, 85435, 78465, 82282, 120719, 112721, 137855, 94412, 70902, 141385, 97044, 135917, 110967, 140328, 131550, 86806, 73363, 121996, 134835, 99343, 135951, 137573, 100923, 78473, 78466, 100922, 68163, 137554, 137568, 139966, 136017, 135920, 131551, 113329, 137563, 102532, 68150, 78468, 94400, 78429, 78432, 78437, 78440, 78430, 78436, 78431, 78439, 82285, 78434, 78442, 78438, 78441, 78435, 78433, 82286, 135968, 90107, 86830, 82284, 79353, 131552, 131540, 131541, 131544, 131546, 86828, 131547, 86843, 86832, 86841, 86836, 94407, 90110, 131539, 98929, 86831, 86838, 131548, 86839, 131543, 86835, 94416, 86840, 131542, 114216, 99332, 131549, 110109, 97065, 98849, 98847, 110107, 98569, 109625, 98568, 98567, 110108, 94411, 113326, 82291, 86829, 150161, 146971, 150162, 150160, 146970, 146972, 86834, 141363, 70900, 141194, 141162, 141193, 111943, 141405, 101852, 141364, 140973, 141163, 141406, 135949, 137854, 78444, 136167, 137548, 137657, 98848, 137549, 136030, 137553, 136029, 120063, 139965, 137550, 86842, 135944, 114219, 120087, 114215, 137658, 114218, 135936, 117142, 99331, 87623, 135967, 94399, 131545, 112720, 140322, 135945, 114638, 86833, 120088, 102417, 137848, 135942, 135919, 135918, 140974, 135943, 101851, 117141, 87624, 141369, 141410, 150727, 112538, 112555, 137753, 83698, 120077, 142137, 151390, 150856, 87541, 78457, 56247, 112719, 117151, 102426, 78456, 110961, 151433, 109626, 111626, 137656, 141370, 140207, 78694, 102535, 137849, 85433, 141400, 120092, 110908, 141368, 85434, 140958, 150254, 151908, 112493, 150132, 101727, 147570, 87161, 151543, 150159, 114404, 151542, 151541, 139963, 150287, 6003, 139962, 136039, 6004, 152483, 141105, 120314, 137850, 141754, 147089, 120384, 97662, 96987, 114981, 83158, 152420, 150243, 67658, 152286, 151903, 152288, 150094, 137682, 140217, 93965, 100649, 122770, 139938, 85469, 96744, 142445, 73787, 151915, 90666, 74496, 110330, 142103, 110328, 152399, 152965, 140213, 116384, 151901, 5303, 116358, 152846, 100077, 5766, 153518, 150170, 120256, 112164, 110930, 152097, 151341, 152823, 150182, 152474, 137520, 112126, 153611, 111146, 135667, 140347, 150167, 150878, 70259, 150166, 150858, 136173, 151752, 114416, 141409, 150875, 151726, 113774, 137519, 112073, 97659, 139964, 147438, 142161, 136166, 116490, 137584, 142500, 137659, 142074, 114413, 6098, 89637, 151343, 141107, 151503, 137841, 84447, 141104, 97069, 151921, 99918, 139181, 68149, 150050, 151961, 49546, 152896, 122659, 151897, 141480, 154679, 147073, 76964, 88538, 90282, 111680, 113919, 98736, 137368, 137366, 152736, 153316, 153760, 147617, 112072, 98687, 151221, 147440, 150781, 152920, 136080, 150710, 102181, 151605, 136043, 151064, 100950, 141885, 114403, 151725, 151436, 151719, 152910, 108402, 152412, 68168, 154604, 152919, 116142, 75871, 116364, 151437, 152234, 152402, 98921, 137725, 148011, 142485, 85443, 152782, 65308, 65307, 151932, 83249, 152237, 67280, 111259, 27338, 101489, 72410, 67169, 102253, 102252, 154305, 57370, 52817, 47909, 68276, 75413, 110723, 90576, 52804, 60985, 98347, 60986, 98823, 5483, 83490, 93632, 94252, 5875, 6049, 152497, 93565, 94251, 90888, 152966, 110925, 140916, 155571, 94572, 88433, 147475, 153154, 113337, 152748, 99047, 147474, 70898, 121587, 113336, 97878, 110103, 135131, 121589, 151530, 135986, 140348, 108827, 97057, 101538, 122051, 110954, 114414, 136023, 136024, 110957, 150872, 114407, 153689, 141118, 152876, 115371, 86837, 122703, 153331, 147441, 27655, 97694, 98999, 97983, 89908, 90876, 141645, 154761, 75630, 97116, 112541, 155706, 155276, 153739, 151546, 152413, 151545, 155869, 151544, 154606, 155870, 154605, 150874, 84656, 83542, 137886, 154922, 156055, 111571, 152935, 114412, 56050, 61049, 65309, 98636, 155997, 155269, 156183, 155285, 6007, 156001, 155843, 6179, 153507, 142504, 151342, 70029, 155846, 140821, 152466, 147169, 156453, 74312, 152824, 156755, 155998, 156749, 84753, 66581, 89410, 98207, 101537, 154764, 88411, 147167, 88461, 152416, 140761, 153600, 122548, 151263, 151264, 151271, 155624, 155625, 156492, 152417, 156490, 156491, 156206, 152676, 150463, 52964, 156631, 57016, 69071, 83693, 151258, 150290, 56692, 72345, 90866, 108381, 154887, 139820, 114368, 154766, 151425, 155544, 155055, 57416, 152209, 154457, 154805, 140727, 96600, 153224, 155550, 156409, 156354, 156410, 156408, 140746, 152485, 112632, 154455, 155572, 150997, 150077, 154914, 156477, 89090, 122455, 137237, 151424, 90603, 141333, 152947, 141304, 89517, 152841, 156476, 153725, 94854, 71926, 152953, 70965, 94647, 86783, 154997, 63184, 142344, 78340, 157035, 76944, 120337, 156350, 156721, 156718, 156809, 156368, 157423, 89854, 156567, 156858, 155637, 157439, 157429, 157430, 157425, 156970, 120070, 116311, 113560, 150238, 156737, 150725, 84895, 108403, 101753, 76950, 57432, 83406, 56202, 154203, 156018, 156632, 156675, 151635, 155636, 155631, 157174, 121932, 155027, 156198, 155911, 154705, 157198, 155811, 155810, 156389, 157005, 157006, 157032, 156397, 157382, 157628, 154750, 156267, 152020, 152901, 154280, 155452, 156277, 152021, 156278, 154985, 157499, 101139, 87641, 78885, 152262, 152453, 72305, 153515, 98147, 110025, 152579, 156079, 153606, 154990, 154806, 156344, 137670, 150415, 5596, 6169, 109852, 153508, 140668, 94920, 122053, 154504, 157667, 137825, 100976, 157678, 78165, 98816, 101091, 5112, 89416, 155833, 121891, 156454, 153511, 153662, 5075, 116497, 156763, 156441, 156750, 157496, 84755, 110692, 149981, 157511, 102286, 157138, 157508, 156884, 156873, 6135, 157495, 157153, 94450, 156178, 155731, 5292, 26947, 157134, 110338, 110337, 77500, 88416, 74569, 87501, 98188, 71193, 71194, 116456, 76748, 5459, 76707, 76706, 139978, 59495, 147164, 151497, 153663, 156753, 157154, 140182, 74783, 101738, 101739, 101740, 141325, 85598, 101405, 153728, 75310, 156197, 157558, 158104, 157102, 94344, 116144, 158258, 158259, 156657, 156658, 155857, 157783, 157782, 156232, 156648, 156894) then 1 end as dre_ok from (select atr.atr_caff_traitant_id, atr.atr_sous_domaine_id,atr.id,atr.atr_ui,atr.partner,atr.ft_numero_oeie,atr.ft_oeie_dre,atr.name as domaine,account_analytic_account.name as sous_domaine,atr.ft_pg, CASE WHEN LENGTH(ft_sous_justification_oeie) = 2 THEN ft_sous_justification_oeie ELSE 'Pas de SJ' END AS ft_sous_justification_oeie, atr.ft_libelle_commune,atr.ft_libelle_de_voie,atr.name_related,atr.work_email,atr.mobile_phone,atr.ft_commentaire_creation_oeie from(
                select ag_poi.atr_caff_traitant_id, ag_poi.atr_sous_domaine_id,ag_poi.id,ag_poi.atr_ui,res_partner.name as partner,ag_poi.ft_oeie_dre,ag_poi.ft_numero_oeie,account_analytic_account.name,ag_poi.ft_pg,ag_poi.ft_sous_justification_oeie,ag_poi.ft_libelle_commune,ag_poi.ft_libelle_de_voie,hr_employee.name_related,hr_employee.work_email,hr_employee.mobile_phone,ag_poi.ft_commentaire_creation_oeie from ag_poi
                left join account_analytic_account on ag_poi.atr_domaine_id = account_analytic_account.id
                left join hr_employee on ag_poi.atr_caff_traitant_id = hr_employee.id
                left join res_partner on ag_poi.res_partner_id = res_partner.id
                where ft_etat = '1' and name_related is not null and ag_poi.atr_caff_traitant_id =  id  and work_email is not null and ag_poi.ft_numero_oeie not like '%MBB%')atr
                left join account_analytic_account on atr.atr_sous_domaine_id = account_analytic_account.id
                order by ft_oeie_dre)dre)dre2 group by atr_caff_traitant_id)cette_req)retard_total * (reactive * 1)
        - ((SELECT COUNT(*) nb FROM ag_poi WHERE atr_caff_traitant_id = caff.id AND sqrt(power((ft_longitude - 46.95)/0.0090808,2)+power((ft_latitude - 5.88333)/0.01339266,2)) < 20 AND ft_etat = '1') * 0.5) 
		+ ((SELECT COUNT(*) nb FROM ag_poi WHERE atr_caff_traitant_id = caff.id AND "ft_numero_demande_42C" = 'A1701336' AND "ft_numero_demande_42C" IS NOT NULL AND "ft_numero_demande_42C" != '' AND "ft_numero_demande_42C" != 'suppr. CNIL') * 0.8)
        )charge_totale 
		FROM (select id, t3.ag_coeff_traitement, t3.name_related, t3.mobile_phone, t3.work_email, t3.site, t3.site_id, t3.agence,case when t3.reactive is null then 0 else t3.reactive end,
		case when t3.non_reactive is null then 0 else t3.non_reactive end from
		(
		select t2.id, t2.ag_coeff_traitement, t2.name_related, t2.mobile_phone, t2.work_email, t2.site, t2.site_id, t2.name as agence, sum(t2.reactive) as reactive, sum(t2.non_reactive) as non_reactive from (
		 
		select t1.id, t1.ag_coeff_traitement, t1.name_related,t1.mobile_phone,t1.work_email,t1.site, t1.site_id,t1.name, case when account_analytic_account.name in ('Client', 'FO & CU') then count (ag_poi.id)
		end as reactive , case when account_analytic_account.name not in ('Client', 'FO & CU') then count (ag_poi.id) end as non_reactive
		from ag_poi
		left join account_analytic_account on ag_poi.atr_domaine_id = account_analytic_account.id  
		full join
		(select hr_employee.id, hr_employee.ag_coeff_traitement, hr_employee.name_related,hr_employee.mobile_phone,hr_employee.work_email,ag_site.name as site, ag_site.id as site_id,ag_agence.name from res_users
		full join hr_employee on res_users.ag_employee_id = hr_employee.id
		full join ag_site on hr_employee.ag_site_id = ag_site.id
		full join ag_agence on hr_employee.ag_agence_id = ag_agence.id
		full join hr_job on hr_employee.job_id = hr_job.id
		where res_users.active = true and hr_job.name in ('CAFF FT','CAFF MIXTE')) t1 on ag_poi.atr_caff_traitant_id = t1.id and ft_etat in ('1','5') and ag_poi.ft_numero_oeie not like '%MBB%'
		group by t1.id, t1.name_related,t1.mobile_phone,t1.work_email,t1.site,t1.name, account_analytic_account.name, t1.site_id, t1.ag_coeff_traitement) t2
		group by t2.id, t2.name_related, t2.mobile_phone, t2.work_email, t2.site, t2.name, t2.site_id, t2.ag_coeff_traitement ) t3
		where name_related is not null AND site_id IN(15, 16, 17))caff
        ORDER BY charge_totale";
?>